# 仕様書：おうちレジ（CoreS3 / 1Dバーコード / RFID）

## 1. 目的
- 幼児向けの「レジごっこ＋キャッシュレス決済ごっこ」を提供する。
- 実在の商品情報や外部サービス連携には依存しない。
- 金額計算は税なしの単純加算とする。

## 2. 対象環境
- ハードウェア: M5Stack CoreS3
- 入力デバイス:
  - 1Dバーコードスキャナ
  - RFIDリーダー
- 出力:
  - 画面表示（タッチ操作あり）
  - スピーカー再生
- ネットワーク: 不要

## 3. 用語
- `code`: バーコード入力で得られる文字列
- `uid`: RFID入力で得られる識別子文字列
- `item`: 1件の商品情報（名称・価格）
- `cart`: 会計中の商品明細リスト

## 4. 画面仕様
### 4.1 通常画面
以下を常時表示する。
- 明細リスト（読み取り順）
- 合計点数
- 合計金額
- `CLEAR` ボタン

表示ルール:
- 明細表示には上限件数を設ける。
- 上限超過時は最新の明細を優先して表示する。
- 1行に収まらない明細は省略記号で短縮表示する。

### 4.2 決済完了画面
RFID決済時に、購入完了メッセージを表示する。
- 例: `お買いあげ ありがとうございます`

表示は固定時間で自動終了し、通常画面に戻る。

## 5. 操作仕様
### 5.1 CLEAR
- 押下時に `cart` を全削除する。
- 合計点数・合計金額は 0 に戻る。

### 5.2 バーコード読み取り
- 入力文字列は前後空白を除去して扱う。
- 空文字や短すぎる入力は無効として無視する。
- 有効入力時にスキャン音を再生する。
- 決定した商品を `cart` 末尾へ追加し、表示を更新する。

### 5.3 RFID読み取り
- 入力文字列は前後空白を除去して扱う。
- 空文字や短すぎる入力は無効として無視する。
- 決済開始時は決済完了画面に遷移し、決済音を再生する。
- 決済処理後は `cart` が空であること。

## 6. 商品決定ロジック
- `code` から商品名と価格を決定する。
- 同一 `code` からは毎回同一結果を返す（冪等）。
- 決定方式:
  - 商品名候補配列とハッシュを組み合わせて商品名を決定
  - 価格は固定レンジ（50〜500円、10円刻み）で算出
- ハッシュ入力は用途別ソルトを用いて分離する。
  - 商品名用: `|NAME|v1`
  - 価格用: `|PRICE|v1`

## 7. 状態管理
最小状態機械:
- `NORMAL`
  - バーコード受付
  - RFID受付
  - CLEAR受付
- `THANK_YOU`
  - 決済完了画面表示中
  - 追加入力は受け付けない

## 8. 音仕様
- スキャン音: 短いビープ
- 決済音: 短いメロディ
- 起動音: 起動完了を示す短音
- 音量・音階・長さは調整可能な設定として管理する。

## 9. 受け入れ条件
- 起動直後に通常画面が表示され、点数0・合計0である。
- バーコード読み取りで商品が追加され、合計が更新される。
- 同一 `code` は常に同じ商品名・価格を返す。
- CLEARで `cart` が空になる。
- RFIDで決済完了画面が表示され、決済音が再生される。
- 決済完了表示中にRFIDを連続入力しても決済処理が重複しない。
